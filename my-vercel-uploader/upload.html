<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qloud — Upload (with Token Merge)</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
  body {
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  .file-item.selected {
    border: 2px solid rgba(59,130,246,1);
    box-shadow: 0 0 10px rgba(59,130,246,.35);
  }
  .file-card {
    position: relative;
  }

  .file-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 6px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .file-card:hover .file-actions {
    opacity: 1;
  }

  .file-action-btn {
    width: 28px;
    height: 28px;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.55);
    cursor: pointer;
  }

  .file-action-btn:hover {
    background: rgba(0,0,0,0.8);
  }

  /* simple modal backdrop */
  .modal-backdrop { background: rgba(2,6,23,0.6); }
</style>
</head>
  
<body class="bg-slate-900 text-slate-100 min-h-screen p-6">

<div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">

  <!-- SIDEBAR -->
  <div class="lg:col-span-1 bg-white/5 backdrop-blur p-4 rounded-xl">
    <div class="flex items-center gap-3">
      <div id="avatarPreview" class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center text-xl">U</div>
      <div class="flex-1">
        <div id="profileName" class="font-semibold">Profile</div>
        <div id="profileToken" class="text-xs opacity-70"></div>
      </div>

      <!-- 3-dot menu moved to sidebar (profile area) -->
      <div class="relative">
        <button id="menuBtn" class="px-3 py-2 rounded bg-white/5 hover:bg-white/10">
          <i data-lucide="more-vertical"></i>
        </button>
        <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-44 bg-slate-800 rounded shadow-lg p-2 z-20">
          <button id="menuMerge" class="w-full text-left px-3 py-2 rounded hover:bg-white/5">Token Merge</button>
          <button id="menuDelete" class="w-full text-left px-3 py-2 rounded hover:bg-white/5">Delete Token</button>
          <button id="menuLogout" class="w-full text-left px-3 py-2 rounded hover:bg-white/5">Log out</button>
        </div>
      </div>
    </div>

    <button id="logoutBtn" class="mt-6 w-full py-2 rounded bg-white/5 hover:bg-white/10">
      Log out
    </button>
  </div>

  <!-- MAIN (only file operations here) -->
  <div class="lg:col-span-3 bg-white/5 backdrop-blur p-6 rounded-xl">

    <div id="msg" class="hidden p-3 rounded text-sm mb-4"></div>

    <!-- UPLOAD BOX (CLICK + DRAG) -->
    <div
      id="uploadBox"
      class="border-2 border-dashed border-indigo-500 rounded-xl p-10 text-center cursor-pointer
             bg-indigo-900/10 hover:bg-indigo-900/20 transition"
    >
      <input id="fileInput" type="file" multiple hidden />
      <div class="text-5xl mb-2">☁️</div>
      <div class="font-bold">Click or drag & drop files here</div>
      <div class="text-sm opacity-70 mt-1">Files are private to this token</div>
    </div>

    <!-- PROGRESS -->
    <div id="progressWrap" class="hidden mt-4">
      <div class="w-full bg-white/10 rounded-full h-2">
        <div id="progressFill" class="h-2 rounded-full bg-gradient-to-r from-blue-500 to-cyan-400"></div>
      </div>
      <div id="statusText" class="text-xs opacity-70 mt-1"></div>
    </div>

    <!-- FILE LIST -->
    <div class="mt-6">
      <h2 class="font-bold mb-3">
        Files <span id="count" class="text-sm opacity-70"></span>
      </h2>

      <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
    </div>

  </div>
</div>

<!-- TOKEN MERGE MODAL -->
<div id="mergeModal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
  <div class="bg-slate-900/95 border border-white/5 rounded-xl w-full max-w-2xl p-6">
    <div class="flex items-start justify-between">
      <h3 class="text-lg font-semibold">Merge tokens into current token</h3>
      <button id="closeMerge" class="text-xs opacity-60">Close</button>
    </div>

    <div class="mt-4 space-y-3">
      <div>
        <div class="text-xs opacity-60">Destination (current token)</div>
        <div id="mergeDest" class="font-medium bg-white/5 p-2 rounded mt-1"></div>
      </div>

      <div>
        <label class="text-xs opacity-60">Search tokens to add as <strong>sources</strong></label>
        <div class="flex gap-2 mt-2">
          <input id="tokenSearchInput" class="flex-1 p-2 rounded bg-white/5" placeholder="Search tokens by id or name" />
          <button id="tokenSearchBtn" class="px-3 py-2 rounded bg-indigo-600">Search</button>
        </div>
        <div id="searchResults" class="mt-2 grid gap-2"></div>
      </div>

      <div>
        <div class="text-xs opacity-60">Selected sources</div>
        <div id="selectedSources" class="mt-2 space-y-2"></div>
      </div>

      <div>
        <label class="text-xs opacity-60">Type <strong>MERGE</strong> to confirm</label>
        <input id="mergeConfirmInput" class="w-full p-2 rounded bg-white/5 mt-1" placeholder="Type MERGE to enable" />
      </div>

      <div class="flex items-center justify-end gap-2">
        <button id="startMergeBtn" class="px-4 py-2 rounded bg-red-600 opacity-60" disabled>Merge now</button>
      </div>

      <div id="mergeStatus" class="text-sm opacity-70"></div>
    </div>
  </div>
</div>

<script>
/* =========================
   FILE ICONS
========================= */
function getFileIcon(publicId) {
  const ext = publicId.split('.').pop().toLowerCase();
  if (['jpg','jpeg','png','gif','webp','svg'].includes(ext)) return 'image';
  if (['mp4','mkv','avi','mov','webm'].includes(ext)) return 'video';
  if (['mp3','wav','ogg','aac','flac'].includes(ext)) return 'music';
  if (['zip','rar','7z','tar','gz'].includes(ext)) return 'archive';
  if (['pdf'].includes(ext)) return 'file-text';
  if (['txt','md','json','js','html','css'].includes(ext)) return 'file-code';
  return 'file';
}

/* =========================
   CONFIG
========================= */
const CLOUD_NAME = 'dzvz7kzin';
const UPLOAD_PRESET = 'mycloud_unsigned';
const BASE_FOLDER = 'mycloud';

const token = new URLSearchParams(location.search).get('token');
if (!token) location.href = 'index.html';

// display token in sidebar
document.getElementById('profileToken').textContent = 'token: ' + token;
document.getElementById('mergeDest').textContent = token;

/* =========================
   UI REFS
========================= */
const uploadBox = document.getElementById('uploadBox');
const fileInput = document.getElementById('fileInput');
const fileGrid = document.getElementById('fileGrid');
const countEl = document.getElementById('count');
const msgEl = document.getElementById('msg');
const progressWrap = document.getElementById('progressWrap');
const progressFill = document.getElementById('progressFill');
const statusText = document.getElementById('statusText');

let files = [];

/* =========================
   HELPERS
========================= */
function showMsg(text, type='info'){
  msgEl.textContent = text;
  msgEl.className =
    'p-3 rounded mb-4 text-sm ' +
    (type==='success' ? 'bg-emerald-500/20 text-emerald-300' :
     type==='error' ? 'bg-red-500/20 text-red-300' :
     'bg-white/10');
  msgEl.classList.remove('hidden');
  setTimeout(()=>msgEl.classList.add('hidden'), 3000);
}

/* =========================
   FETCH FILES
========================= */
async function fetchFiles(){
  try {
    const res = await fetch(`/api/list-files?token=${encodeURIComponent(token)}`);
    const data = await res.json();
    files = (data.resources || []).sort(
      (a,b)=> new Date(b.created_at) - new Date(a.created_at)
    );
    renderFiles();
  } catch (err) {
    console.error(err);
    showMsg('Failed to load files','error');
  }
}

/* =========================
   RENDER FILES
========================= */
function renderFiles(){
  countEl.textContent = `(${files.length})`;
  fileGrid.innerHTML = '';

  if (!files.length) {
    fileGrid.innerHTML =
      '<div class="col-span-full text-center opacity-60">No files uploaded yet</div>';
    return;
  }

  files.forEach(f => {
    const name = f.public_id.split('/').pop();
    const size = (f.bytes / 1024 / 1024).toFixed(2);
    const icon = getFileIcon(f.public_id);

    const card = document.createElement('div');
    card.className = 'file-card bg-white/10 rounded-xl p-4 hover:bg-white/15 transition';

    card.innerHTML = `
      <div class="file-actions">
        <button class="file-action-btn text-emerald-400 download-btn">
          <i data-lucide="download"></i>
        </button>
        <button class="file-action-btn text-red-400 delete-btn">
          <i data-lucide="trash-2"></i>
        </button>
      </div>

      <div class="text-4xl mb-2 text-indigo-300">
        <i data-lucide="${icon}"></i>
      </div>
      <div class="font-semibold truncate">${name}</div>
      <div class="text-xs opacity-60 mt-1">${size} MB</div>
    `;

    // DOWNLOAD
    card.querySelector('.download-btn').onclick = () =>
      forceDownload(f.secure_url, name);

    // DELETE
    card.querySelector('.delete-btn').onclick = () => {
      deleteFile(f.public_id);
    };

    fileGrid.appendChild(card);
  });

  lucide.createIcons();
}

/* =========================
   UPLOAD
========================= */
uploadBox.addEventListener('click', () => fileInput.click());

uploadBox.addEventListener('dragover', e => {
  e.preventDefault();
  uploadBox.classList.add('bg-indigo-900/30');
});

uploadBox.addEventListener('dragleave', () =>
  uploadBox.classList.remove('bg-indigo-900/30')
);

uploadBox.addEventListener('drop', e => {
  e.preventDefault();
  uploadBox.classList.remove('bg-indigo-900/30');
  uploadFiles([...e.dataTransfer.files]);
});

fileInput.onchange = e => uploadFiles([...e.target.files]);

async function uploadFiles(list){
  if (!list.length) return;
  progressWrap.classList.remove('hidden');

  for (let i=0;i<list.length;i++){
    const fd = new FormData();
    fd.append('file', list[i]);
    fd.append('upload_preset', UPLOAD_PRESET);
    fd.append('folder', `${BASE_FOLDER}/${token}`);

    statusText.textContent = `Uploading ${list[i].name}`;
    progressFill.style.width = ((i+1)/list.length*100)+'%';

    const res = await fetch(
      `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/raw/upload`,
      { method:'POST', body:fd }
    );

    if (!res.ok) {
      showMsg(`Upload failed: ${list[i].name}`,'error');
      break;
    }
  }

  progressWrap.classList.add('hidden');
  progressFill.style.width = '0%';
  fetchFiles();
}

/* =========================
   DELETE
========================= */
async function deleteFile(publicId){
  try {
    const res = await fetch('/api/delete-file', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ public_id: publicId })
    });
    if (!res.ok) throw new Error();
     fetchFiles();
  } catch (err) {
    console.error(err);
    showMsg('Delete failed','error');
  }
}

/* =========================
   FORCE DOWNLOAD
========================= */
async function forceDownload(url, filename) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error();
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  } catch (err) {
    console.error(err);
    showMsg('Download failed','error');
  }
}

/* =========================
   INIT
========================= */
fetchFiles();
document.getElementById('logoutBtn').onclick =
  () => location.href = 'index.html';

/* =========================
   MENU AND MERGE UI LOGIC
========================= */
const menuBtn = document.getElementById('menuBtn');
const menuDropdown = document.getElementById('menuDropdown');
const menuMerge = document.getElementById('menuMerge');
const menuDelete = document.getElementById('menuDelete');
const menuLogout = document.getElementById('menuLogout');

menuBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  menuDropdown.classList.toggle('hidden');
});

document.addEventListener('click', ()=> menuDropdown.classList.add('hidden'));

menuLogout.addEventListener('click', ()=> location.href='index.html');

// Merge modal elements
const mergeModal = document.getElementById('mergeModal');
const closeMerge = document.getElementById('closeMerge');
const tokenSearchInput = document.getElementById('tokenSearchInput');
const tokenSearchBtn = document.getElementById('tokenSearchBtn');
const searchResults = document.getElementById('searchResults');
const selectedSourcesEl = document.getElementById('selectedSources');
const mergeConfirmInput = document.getElementById('mergeConfirmInput');
const startMergeBtn = document.getElementById('startMergeBtn');
const mergeStatus = document.getElementById('mergeStatus');

let selectedSources = [];

menuMerge.addEventListener('click', (e)=>{
  e.stopPropagation();
  openMergeModal();
});

closeMerge.addEventListener('click', closeMergeModal);

function openMergeModal(){
  selectedSources = [];
  renderSelectedSources();
  tokenSearchInput.value = '';
  searchResults.innerHTML = '';
  mergeConfirmInput.value = '';
  startMergeBtn.disabled = true;
  startMergeBtn.classList.add('opacity-60');
  mergeStatus.textContent = '';
  mergeModal.classList.remove('hidden');
  // ensure destination displays current token
  document.getElementById('mergeDest').textContent = token;
}

function closeMergeModal(){
  mergeModal.classList.add('hidden');
}

// simple search - calls backend endpoint /api/search-tokens?q=...
async function searchTokens(query){
  if (!query) return [];
  try {
    const res = await fetch(`/api/search-tokens?q=${encodeURIComponent(query)}`);
    if (!res.ok) throw new Error('search failed');
    const data = await res.json();
    return data.tokens || [];
  } catch (err){
    console.error(err);
    showMsg('Token search failed','error');
    return [];
  }
}

tokenSearchBtn.addEventListener('click', async ()=>{
  const q = tokenSearchInput.value.trim();
  searchResults.innerHTML = 'Searching...';
  const hits = await searchTokens(q);
  if (!hits.length) {
    searchResults.innerHTML = '<div class="opacity-60 text-sm">No tokens found</div>';
    return;
  }
  searchResults.innerHTML = '';
  hits.forEach(t => {
    // t should contain at least { id, name }
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between p-2 bg-white/5 rounded';
    row.innerHTML = `
      <div class="truncate">${t.id}${t.name ? ' — '+t.name : ''}</div>
      <button class="px-2 py-1 rounded bg-indigo-600 add-source-btn">Add</button>
    `;
    row.querySelector('.add-source-btn').onclick = ()=> addSource(t.id);
    searchResults.appendChild(row);
  });
});

function addSource(id){
  if (!id || id === token) return showMsg('Cannot add current token as source','error');
  if (selectedSources.includes(id)) return showMsg('Already added','info');
  selectedSources.push(id);
  renderSelectedSources();
}

function removeSource(id){
  selectedSources = selectedSources.filter(x=>x!==id);
  renderSelectedSources();
}

function renderSelectedSources(){
  selectedSourcesEl.innerHTML = '';
  if (!selectedSources.length) {
    selectedSourcesEl.innerHTML = '<div class="opacity-60 text-sm">No sources selected</div>';
    return;
  }
  selectedSources.forEach(s => {
    const item = document.createElement('div');
    item.className = 'flex items-center justify-between p-2 bg-white/5 rounded';
    item.innerHTML = `<div class="truncate">${s}</div><button class="px-2 py-1 rounded bg-red-600 remove-source-btn">Remove</button>`;
    item.querySelector('.remove-source-btn').onclick = ()=> removeSource(s);
    selectedSourcesEl.appendChild(item);
  });
}

mergeConfirmInput.addEventListener('input', ()=>{
  const val = mergeConfirmInput.value.trim();
  if (val === 'MERGE' && selectedSources.length>0) {
    startMergeBtn.disabled = false;
    startMergeBtn.classList.remove('opacity-60');
  } else {
    startMergeBtn.disabled = true;
    startMergeBtn.classList.add('opacity-60');
  }
});

startMergeBtn.addEventListener('click', async ()=>{
  if (!selectedSources.length) return showMsg('Add at least one source token','error');
  if (mergeConfirmInput.value.trim() !== 'MERGE') return showMsg('Type MERGE to confirm','error');

  // make POST to backend
  try {
    startMergeBtn.disabled = true;
    mergeStatus.textContent = 'Merging... this may take a while';

    const res = await fetch('/api/merge-tokens', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dest: token, sources: selectedSources })
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error(txt || 'merge failed');
    }

    const result = await res.json();
    mergeStatus.textContent = 'Merge successful';
    showMsg('Tokens merged successfully','success');
    closeMergeModal();
    // refresh files to reflect newly moved files
    fetchFiles();
  } catch (err) {
    console.error(err);
    mergeStatus.textContent = 'Merge failed: '+(err.message||'');
    showMsg('Merge failed','error');
    startMergeBtn.disabled = false;
  }
});

// delete token button - simple flow (UI only)
menuDelete.addEventListener('click', ()=>{
  if (!confirm('Delete this token and all its files? This is irreversible.')) return;
  // call backend to delete token and files
  fetch('/api/delete-token', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ token })
  }).then(r=>{
    if (r.ok) {
      showMsg('Token deleted','success');
      location.href = 'index.html';
    } else showMsg('Delete failed','error');
  }).catch(e=>{ console.error(e); showMsg('Delete failed','error'); });
});

</script>

</body>
 
</html>
