<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qloud ‚Äî Upload</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
:root{
  --panel: rgba(255,255,255,0.04);
  --accent-from:#6366f1;
  --accent-to:#06b6d4;
}
body{font-family:Inter,system-ui}
.panel{background:var(--panel)}
.file-card{position:relative}
.file-actions{position:absolute;top:10px;right:10px;opacity:0;transition:.2s}
.file-card:hover .file-actions{opacity:1}
.file-action-btn{width:34px;height:34px;border-radius:10px;background:rgba(255,255,255,.06)}
.theme-toggle{background:rgba(255,255,255,.06);border-radius:999px;padding:6px 10px}
body.light{background:#f8fafc;color:#0f172a}
body.light .panel{background:rgba(2,6,23,.04)}
</style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen p-6" id="bodyRoot">

<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">

<!-- LEFT SIDEBAR -->
<aside class="panel rounded-xl p-4 space-y-6 sticky top-6">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div id="avatarPreview" class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-600 to-cyan-400 flex items-center justify-center font-bold">U</div>
      <div>
        <div id="profileName" class="font-semibold">Profile</div>
        <div id="profileToken" class="text-xs opacity-70">token:</div>
      </div>
    </div>

    <div class="relative">
      <button id="threeDotMenuBtnLeft"><i data-lucide="more-vertical"></i></button>
      <div id="threeDotMenuLeft" class="hidden absolute right-0 mt-2 w-44 bg-slate-800 rounded shadow">
        <button id="menuMergeLeft" class="w-full px-4 py-2 text-left hover:bg-white/10">Merge token</button>
        <button id="menuDeleteLeft" class="w-full px-4 py-2 text-left hover:bg-red-600/20">Delete token</button>
        <button id="menuLogoutLeft" class="w-full px-4 py-2 text-left hover:bg-white/10">Logout</button>
      </div>
    </div>
  </div>

  <div>
    <div class="text-xs opacity-70 mb-1">Storage (global)</div>
    <div class="h-2 bg-white/10 rounded">
      <div id="storageFill" class="h-2 rounded bg-gradient-to-r from-indigo-500 to-cyan-400" style="width:0%"></div>
    </div>
    <div id="storageText" class="text-xs opacity-60 mt-1">‚Äî</div>
  </div>

  <div class="space-y-2">
    <button id="openMerge" class="w-full py-2 bg-white/5 rounded">Merge tokens</button>
    <button id="openDelete" class="w-full py-2 bg-white/5 rounded">Delete token</button>
    <button id="logoutBtn" class="w-full py-2 bg-red-600/20 rounded">Log out</button>
  </div>
</aside>

<!-- MAIN FILE AREA -->
<main class="lg:col-span-3 panel rounded-xl p-6 relative">

  <!-- Theme toggle -->
  <div class="absolute top-6 right-6">
    <button id="themeToggle" class="theme-toggle flex gap-2 items-center">
      <i data-lucide="sun"></i>
      <i data-lucide="moon"></i>
    </button>
  </div>

  <!-- Upload -->
  <div id="uploadBox" class="border-2 border-dashed border-indigo-500 rounded-xl p-10 text-center cursor-pointer">
    <input id="fileInput" type="file" multiple hidden>
    <div class="text-5xl mb-2">‚òÅÔ∏è</div>
    <div class="font-bold">Click or drag & drop files</div>
    <div class="text-sm opacity-70">Private to this token</div>
  </div>

  <!-- Progress -->
  <div id="progressWrap" class="hidden mt-4">
    <div class="h-2 bg-white/10 rounded">
      <div id="progressFill" class="h-2 rounded bg-gradient-to-r from-indigo-500 to-cyan-400"></div>
    </div>
    <div id="statusText" class="text-xs opacity-70 mt-1"></div>
  </div>

  <!-- Files -->
  <div class="mt-6">
    <div class="flex justify-between mb-3">
      <h2 class="font-bold">Files <span id="count" class="opacity-60"></span></h2>
      <button id="refreshBtn" class="px-3 py-1 bg-white/5 rounded">Refresh</button>
    </div>
    <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
  </div>

</main>
</div>

<script>
const CLOUD_NAME='dzvz7kzin';
const UPLOAD_PRESET='mycloud_unsigned';
const BASE_FOLDER='mycloud';
const token=new URLSearchParams(location.search).get('token');
if(!token)location.href='index.html';
profileToken.textContent='token: '+token;

const uploadBox=fileInput.parentElement;
let files=[];

/* THEME */
const bodyRoot=document.getElementById('bodyRoot');
const saved=localStorage.getItem('qloud_theme')||'dark';
if(saved==='light')bodyRoot.classList.add('light');
themeToggle.onclick=()=>{
  bodyRoot.classList.toggle('light');
  localStorage.setItem('qloud_theme',bodyRoot.classList.contains('light')?'light':'dark');
};

/* THREE DOT */
threeDotMenuBtnLeft.onclick=()=>threeDotMenuLeft.classList.toggle('hidden');
menuLogoutLeft.onclick=()=>location.href='index.html';
menuMergeLeft.onclick=()=>openMerge();
menuDeleteLeft.onclick=()=>openDelete();

openMerge.onclick=openMerge;
openDelete.onclick=openDelete;
logoutBtn.onclick=()=>location.href='index.html';

/* FILE OPS (unchanged) */
uploadBox.onclick=()=>fileInput.click();
uploadBox.ondragover=e=>e.preventDefault();
uploadBox.ondrop=e=>{e.preventDefault();uploadFiles([...e.dataTransfer.files])};
fileInput.onchange=e=>uploadFiles([...e.target.files]);

async function uploadFiles(list){
  progressWrap.classList.remove('hidden');
  for(let i=0;i<list.length;i++){
    const fd=new FormData();
    fd.append('file',list[i]);
    fd.append('upload_preset',UPLOAD_PRESET);
    fd.append('folder',`${BASE_FOLDER}/${token}`);
    statusText.textContent=`Uploading ${list[i].name}`;
    progressFill.style.width=((i+1)/list.length*100)+'%';
    await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/raw/upload`,{method:'POST',body:fd});
  }
  progressWrap.classList.add('hidden');
  fetchFiles();
}

async function fetchFiles(){
  const res=await fetch(`/api/list-files?token=${token}`);
  const data=await res.json();
  files=data.resources||[];
  renderFiles();
}

function renderFiles(){
  count.textContent=`(${files.length})`;
  fileGrid.innerHTML='';
  files.forEach(f=>{
    const card=document.createElement('div');
    card.className='file-card bg-white/5 rounded-xl p-4';
    card.innerHTML=`
      <div class="file-actions flex gap-2">
        <button class="file-action-btn download">‚¨á</button>
        <button class="file-action-btn delete">üóë</button>
      </div>
      <div class="truncate font-semibold">${f.public_id.split('/').pop()}</div>
    `;
    card.querySelector('.download').onclick=()=>window.open(f.secure_url);
    card.querySelector('.delete').onclick=()=>deleteFile(f.public_id);
    fileGrid.appendChild(card);
  });
}

async function deleteFile(id){
  await fetch('/api/delete-file',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({public_id:id})});
  fetchFiles();
}

refreshBtn.onclick=fetchFiles;
fetchFiles();
lucide.createIcons();
</script>

</body>
</html>
