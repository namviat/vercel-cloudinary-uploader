<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qloud — Upload</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
  body {
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  .file-item.selected {
    border: 2px solid rgba(59,130,246,1);
    box-shadow: 0 0 10px rgba(59,130,246,.35);
  }
  .file-card {
  position: relative;
}

.file-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.file-card:hover .file-actions {
  opacity: 1;
}

.file-action-btn {
  width: 28px;
  height: 28px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.55);
  cursor: pointer;
}

.file-action-btn:hover {
  background: rgba(0,0,0,0.8);
}

</style>
</head>
  
<body class="bg-slate-900 text-slate-100 min-h-screen p-6">

<div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">

<!-- SIDEBAR -->
<div class="lg:col-span-1 bg-white/5 backdrop-blur p-4 rounded-xl">
  <div class="flex items-center gap-3">
    <div id="avatarPreview" class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center text-xl">U</div>
    <div>
      <div id="profileName" class="font-semibold">Profile</div>
      <div id="profileToken" class="text-xs opacity-70"></div>
    </div>
  </div>

  <button id="logoutBtn" class="mt-6 w-full py-2 rounded bg-white/5 hover:bg-white/10">
    Log out
  </button>
</div>

<!-- MAIN -->
<div class="lg:col-span-3 bg-white/5 backdrop-blur p-6 rounded-xl">

  <div id="msg" class="hidden p-3 rounded text-sm mb-4"></div>

  <!-- UPLOAD BOX (CLICK + DRAG) -->
  <div
    id="uploadBox"
    class="border-2 border-dashed border-indigo-500 rounded-xl p-10 text-center cursor-pointer
           bg-indigo-900/10 hover:bg-indigo-900/20 transition"
  >
    <input id="fileInput" type="file" multiple hidden />
    <div class="text-5xl mb-2">☁️</div>
    <div class="font-bold">Click or drag & drop files here</div>
    <div class="text-sm opacity-70 mt-1">Files are private to this token</div>
  </div>

  <!-- PROGRESS -->
  <div id="progressWrap" class="hidden mt-4">
    <div class="w-full bg-white/10 rounded-full h-2">
      <div id="progressFill" class="h-2 rounded-full bg-gradient-to-r from-blue-500 to-cyan-400"></div>
    </div>
    <div id="statusText" class="text-xs opacity-70 mt-1"></div>
  </div>

  <!-- FILE LIST -->
  <div class="mt-6">
    <h2 class="font-bold mb-3">
      Files <span id="count" class="text-sm opacity-70"></span>
    </h2>

    <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
  </div>

</div>
</div>

<script>
  /*=========================
  Auto file-type icon assignment
  ============================*/
  function getFileIcon(publicId) {
  const ext = publicId.split('.').pop().toLowerCase();

  if (['jpg','jpeg','png','gif','webp','svg'].includes(ext)) return 'image';
  if (['mp4','mkv','avi','mov','webm'].includes(ext)) return 'video';
  if (['mp3','wav','ogg','aac','flac'].includes(ext)) return 'music';
  if (['zip','rar','7z','tar','gz'].includes(ext)) return 'archive';
  if (['pdf'].includes(ext)) return 'file-text';
  if (['txt','md','json','js','html','css'].includes(ext)) return 'file-code';

  return 'file';
}

/* =========================
   CONFIG
========================= */
const CLOUD_NAME = 'dzvz7kzin';
const UPLOAD_PRESET = 'mycloud_unsigned';
const BASE_FOLDER = 'mycloud';

const token = new URLSearchParams(location.search).get('token');
if (!token) location.href = 'index.html';

document.getElementById('profileToken').textContent = 'token: ' + token;

/* =========================
   UI REFS
========================= */
const uploadBox = document.getElementById('uploadBox');
const fileInput = document.getElementById('fileInput');
const fileGrid = document.getElementById('fileGrid');
const countEl = document.getElementById('count');
const msgEl = document.getElementById('msg');
const progressWrap = document.getElementById('progressWrap');
const progressFill = document.getElementById('progressFill');
const statusText = document.getElementById('statusText');

let files = [];

function showMsg(text, type='info'){
  msgEl.textContent = text;
  msgEl.className =
    'p-3 rounded mb-4 text-sm ' +
    (type==='success' ? 'bg-emerald-500/20 text-emerald-300' :
     type==='error' ? 'bg-red-500/20 text-red-300' :
     'bg-white/10');
  msgEl.classList.remove('hidden');
  setTimeout(()=>msgEl.classList.add('hidden'), 3000);
}

/* =========================
   FETCH FILES (TOKEN ONLY)
========================= */
async function fetchFiles(){
  try {
    const res = await fetch(`/api/list-files?token=${encodeURIComponent(token)}`);
    const data = await res.json();
    files = data.resources || [];
    renderFiles();
  } catch {
    showMsg('Failed to load files', 'error');
  }
}

function renderFiles(){
  countEl.textContent = `(${files.length})`;
  fileGrid.innerHTML = '';

  if (!files.length) {
    fileGrid.innerHTML =
      '<div class="col-span-full text-center opacity-60">No files uploaded yet</div>';
    return;
  }

  files.forEach(f => {
    const name = f.public_id.split('/').pop();
    const size = (f.bytes / 1024 / 1024).toFixed(2);

    const card = document.createElement('div');
    card.className = 'file-card bg-white/10 rounded-xl p-4 hover:bg-white/15 transition';

    const icon = getFileIcon(f.public_id);

card.innerHTML = `
  <!-- ACTION ICONS -->
  <div class="file-actions">
    <a
      href="${f.secure_url}"
      download
      class="file-action-btn text-emerald-400"
      title="Download"
    >
      <i data-lucide="download"></i>
    </a>

    <button
      class="file-action-btn text-red-400"
      title="Delete"
      data-id="${f.public_id}"
    >
      <i data-lucide="trash-2"></i>
    </button>
  </div>

  <!-- FILE INFO -->
  <div class="text-4xl mb-2 text-indigo-300">
    <i data-lucide="${icon}"></i>
  </div>
  <div class="font-semibold truncate">${name}</div>
  <div class="text-xs opacity-60 mt-1">${size} MB</div>
`;


    // Delete handler
    card.querySelector('button').onclick = () => {
      if (confirm('Delete this file?')) {
        deleteFile(f.public_id);
      }
    };

    fileGrid.appendChild(card);
  });
  lucide.createIcons();

}


/* =========================
   UPLOAD (CLICK + DROP)
========================= */
uploadBox.onclick = () => fileInput.click();

uploadBox.ondragover = e => {
  e.preventDefault();
  uploadBox.classList.add('bg-indigo-900/30');
};

uploadBox.ondragleave = () =>
  uploadBox.classList.remove('bg-indigo-900/30');

uploadBox.ondrop = e => {
  e.preventDefault();
  uploadBox.classList.remove('bg-indigo-900/30');
  uploadFiles([...e.dataTransfer.files]);
};

fileInput.onchange = e =>
  uploadFiles([...e.target.files]);

async function uploadFiles(list){
  if (!list.length) return;

  progressWrap.classList.remove('hidden');

  for (let i=0;i<list.length;i++){
    const fd = new FormData();
    fd.append('file', list[i]);
    fd.append('upload_preset', UPLOAD_PRESET);
    fd.append('folder', `${BASE_FOLDER}/${token}`);

    statusText.textContent = `Uploading ${list[i].name}`;
    progressFill.style.width = ((i+1)/list.length*100)+'%';

    await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/raw/upload`, {
      method:'POST',
      body:fd
    });
  }

  progressWrap.classList.add('hidden');
  showMsg('Upload complete','success');
  fetchFiles();
}

/* =========================
   DELETE FILE
========================= */
async function deleteFile(publicId){

  try {
    const res = await fetch('/api/delete-file', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ public_id: publicId })
    });
    if (!res.ok) throw new Error();
    showMsg('File deleted','success');
    fetchFiles();
  } catch {
    showMsg('Delete failed','error');
  }
}

/* =========================
   INIT
========================= */
fetchFiles();
document.getElementById('logoutBtn').onclick =
  () => location.href = 'index.html';
</script>

</body>
 
</html>
