<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qloud ‚Äî Upload</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
  body {
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  .file-item.selected {
    border: 2px solid rgba(59,130,246,1);
    box-shadow: 0 0 10px rgba(59,130,246,.35);
  }
</style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen p-6">

<div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">

<!-- SIDEBAR -->
<div class="lg:col-span-1 bg-white/5 backdrop-blur p-4 rounded-xl">

  <div class="flex items-center gap-3">
    <div id="avatarPreview" class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center text-xl">U</div>
    <div>
      <div id="profileName" class="font-semibold">Profile</div>
      <div id="profileToken" class="text-xs opacity-70"></div>
    </div>
  </div>

  <div class="mt-4">
    <label class="text-xs opacity-70">Display name</label>
    <input id="profileNameInput" class="w-full mt-1 p-2 rounded bg-transparent border border-white/10" />
    <label class="text-xs opacity-70 mt-3 block">Avatar URL</label>
    <input id="avatarInput" class="w-full mt-1 p-2 rounded bg-transparent border border-white/10" />
    <button id="saveProfile" class="mt-3 w-full py-2 rounded bg-gradient-to-r from-blue-500 to-cyan-400 text-slate-900 font-semibold">
      Save
    </button>
  </div>

  <div class="mt-6">
    <button id="logoutBtn" class="w-full py-2 rounded bg-white/5 hover:bg-white/10">
      Log out
    </button>
  </div>
</div>

<!-- MAIN -->
<div class="lg:col-span-3 bg-white/5 backdrop-blur p-6 rounded-xl">

  <div id="msg" class="hidden p-3 rounded text-sm mb-4"></div>

  <!-- UPLOAD -->
  <div id="uploadBox" class="border-2 border-dashed border-indigo-500 rounded-xl p-6 text-center cursor-pointer bg-indigo-900/10 hover:bg-indigo-900/20">
    <div class="text-5xl">üìÅ</div>
    <div class="font-bold mt-2">Drag & drop or click to upload</div>
    <div class="text-sm opacity-70">Files are private to this token</div>

    <div class="flex justify-center gap-4 mt-4">
      <input id="fileInput" type="file" multiple hidden />
      <button id="pickBtn" class="bg-indigo-500 px-4 py-2 rounded-full font-semibold">Choose files</button>
      <button id="syncBtn" class="bg-white/10 px-4 py-2 rounded-full">Refresh</button>
    </div>
  </div>

  <!-- PROGRESS -->
  <div id="progressWrap" class="hidden mt-4">
    <div class="w-full bg-white/10 rounded-full h-2">
      <div id="progressFill" class="h-2 rounded-full bg-gradient-to-r from-blue-500 to-cyan-400"></div>
    </div>
    <div id="statusText" class="text-xs opacity-70 mt-1"></div>
  </div>

  <!-- FILES -->
  <div class="mt-6">
    <div class="flex justify-between items-center mb-3">
      <h2 class="font-bold">Files <span id="count" class="text-sm opacity-70"></span></h2>
      <button id="zipBtn" class="bg-emerald-500 px-3 py-1 rounded disabled:opacity-40" disabled>
        Download ZIP
      </button>
    </div>

    <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
  </div>

</div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const CLOUD_NAME = 'dzvz7kzin';
const UPLOAD_PRESET = 'mycloud_unsigned';
const BASE_FOLDER = 'mycloud';

const token = new URLSearchParams(location.search).get('token');
if (!token) location.href = 'index.html';

document.getElementById('profileToken').textContent = 'token: ' + token;

/* =========================
   UI HELPERS
========================= */
const fileGrid = document.getElementById('fileGrid');
const countEl = document.getElementById('count');
const msgEl = document.getElementById('msg');
const progressWrap = document.getElementById('progressWrap');
const progressFill = document.getElementById('progressFill');
const statusText = document.getElementById('statusText');
const zipBtn = document.getElementById('zipBtn');

let files = [];
let selected = new Set();

function showMsg(t, type='info'){
  msgEl.textContent = t;
  msgEl.className = 'p-3 rounded mb-4 text-sm ' +
    (type==='success' ? 'bg-emerald-500/20 text-emerald-300' :
     type==='error' ? 'bg-red-500/20 text-red-300' :
     'bg-white/10');
  msgEl.classList.remove('hidden');
  setTimeout(()=>msgEl.classList.add('hidden'), 3500);
}

/* =========================
   LIST FILES (TOKEN ONLY)
========================= */
async function fetchFiles(){
  try {
    const res = await fetch(`/api/list-files?token=${encodeURIComponent(token)}`);
    const data = await res.json();
    files = data.resources || [];
    renderFiles();
  } catch {
    showMsg('Failed to load files', 'error');
  }
}

function renderFiles(){
  countEl.textContent = `(${files.length})`;
  fileGrid.innerHTML = '';

  if (!files.length) {
    fileGrid.innerHTML = '<div class="col-span-full text-center opacity-60">No files yet</div>';
    zipBtn.disabled = true;
    return;
  }

  files.forEach(f => {
    const el = document.createElement('div');
    el.className = 'file-item p-4 bg-white/10 rounded cursor-pointer';
    el.dataset.id = f.public_id;
    el.innerHTML = `
      <div class="font-semibold truncate">${f.public_id.split('/').pop()}</div>
      <div class="text-xs opacity-60">${(f.bytes/1024/1024).toFixed(2)} MB</div>
    `;
    el.onclick = () => {
      selected.has(f.public_id) ? selected.delete(f.public_id) : selected.add(f.public_id);
      el.classList.toggle('selected');
      zipBtn.disabled = selected.size === 0;
    };
    fileGrid.appendChild(el);
  });
}

/* =========================
   UPLOAD
========================= */
document.getElementById('pickBtn').onclick = () =>
  document.getElementById('fileInput').click();

document.getElementById('fileInput').onchange = e =>
  uploadFiles([...e.target.files]);

async function uploadFiles(list){
  progressWrap.classList.remove('hidden');
  for (let i=0;i<list.length;i++){
    const fd = new FormData();
    fd.append('file', list[i]);
    fd.append('upload_preset', UPLOAD_PRESET);
    fd.append('folder', `${BASE_FOLDER}/${token}`);

    statusText.textContent = `Uploading ${list[i].name}`;
    progressFill.style.width = ((i+1)/list.length*100)+'%';

    await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/raw/upload`, {
      method:'POST',
      body:fd
    });
  }
  progressWrap.classList.add('hidden');
  showMsg('Upload complete','success');
  fetchFiles();
}

/* =========================
   ZIP DOWNLOAD
========================= */
zipBtn.onclick = async () => {
  const zip = new JSZip();
  for (const f of files.filter(x=>selected.has(x.public_id))){
    const r = await fetch(f.secure_url);
    zip.file(f.public_id.split('/').pop(), await r.blob());
  }
  const blob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `qloud-${token}.zip`;
  a.click();
};

/* =========================
   INIT
========================= */
fetchFiles();
document.getElementById('logoutBtn').onclick = () => location.href = 'index.html';
</script>

</body>
</html>
