// /api/token.js
const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
const GITHUB_REPO = process.env.GITHUB_REPO; // owner/repo
const TOKENS_FILE_PATH = process.env.TOKENS_FILE_PATH || 'tokens.txt';

if (!GITHUB_TOKEN || !GITHUB_REPO) {
  console.warn('GITHUB_TOKEN or GITHUB_REPO not set in env');
}

async function getFile() {
  const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${TOKENS_FILE_PATH}`;
  const resp = await fetch(url, { headers: { Authorization: `token ${GITHUB_TOKEN}`, Accept: 'application/vnd.github.v3+json' }});
  if (resp.status === 404) return null;
  if (!resp.ok) throw new Error('GitHub get file error: ' + resp.statusText);
  return resp.json();
}

async function putFile(contentBase64, sha, message) {
  const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${TOKENS_FILE_PATH}`;
  const body = { message, content: contentBase64, branch: undefined };
  if (sha) body.sha = sha;
  const resp = await fetch(url, {
    method: 'PUT',
    headers: { Authorization: `token ${GITHUB_TOKEN}`, Accept: 'application/vnd.github.v3+json', 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error('GitHub put file error: ' + resp.status + ' ' + txt);
  }
  return resp.json();
}

module.exports = async (req, res) => {
  try {
    if (req.method !== 'POST') return res.status(405).json({ error: 'POST only' });
    const { token } = req.body || {};
    if (!token || typeof token !== 'string' || !token.trim()) return res.status(400).json({ error: 'token required' });
    const normalized = token.trim();

    const fileData = await getFile();
    if (fileData) {
      const content = Buffer.from(fileData.content, 'base64').toString('utf8');
      const lines = content.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      if (lines.includes(normalized)) {
        return res.status(200).json({ exists: true });
      }
      // append and update
      lines.push(normalized);
      const newContent = lines.join('\n') + '\n';
      const base64 = Buffer.from(newContent, 'utf8').toString('base64');
      await putFile(base64, fileData.sha, `Add token ${normalized} via Qloud`);
      return res.status(200).json({ created: true });
    } else {
      // file doesn't exist: create it with the token
      const newContent = normalized + '\n';
      const base64 = Buffer.from(newContent, 'utf8').toString('base64');
      await putFile(base64, undefined, `Create tokens file and add ${normalized}`);
      return res.status(200).json({ created: true });
    }
  } catch (err) {
    console.error(err);
    return res.status(500).json({ error: err.message || String(err) });
  }
};
